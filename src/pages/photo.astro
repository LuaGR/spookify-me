---
import Layout from '../layouts/Layout.astro'
import { getCldImageUrl } from 'astro-cloudinary/helpers'

const { searchParams } = Astro.url
const id = searchParams.get('id')

if (id == null) return Astro.redirect('/')

const url = getCldImageUrl({ src: id })
console.log({ id, url })
---

<Layout title='Cloudinary Photo'>
  <main data-id={id}>
    <header class='mb-28'>
      <h1 class='text-5xl'>Edit your photo</h1>

      <section>
        <button
          class='add'
          data-topic='ghost'>
          Add phantoms
        </button>

        <button
          class='add'
          data-topic='zombies'>
          Add zombies
        </button>

        <button
          class='add'
          data-topic='devil'>
          Add devil
        </button>
      </section>
    </header>

    <two-up>
      <img
        id='original'
        src={url}
      />
      <img
        id='preview'
        src={url}
      />
    </two-up>
    <small>{url}</small>

    <div>
      <button class='download'> Descargar en Avif </button>
    </div>
  </main>
</Layout>

<style>
  img {
    max-width: 100%;
    height: auto;
    border-radius: 12px;
    transition: opacity 0.3s ease;
  }
</style>

<script>
  import { getCldImageUrl } from 'astro-cloudinary/helpers'
  import 'two-up-element'

  const id = document.querySelector('main')?.getAttribute('data-id') ?? ''
  const preview = document.getElementById('preview') as HTMLImageElement
  const buttons = document.querySelectorAll('button')
  const downloadButton = document.querySelector(
    '.download'
  ) as HTMLButtonElement

  const TOPICS: Record<string, string> = {
    ghost: 'Add scary ghosts to the background',
    zombies: 'Add zombies to the background',
    devil: 'Add some devils to the background',
    custom: ''
  } as const

  buttons.forEach((button) => {
    button.addEventListener('click', (e) => {
      const topic = button.getAttribute('data-topic')
      if (topic == null) return

      const url = getCldImageUrl({
        src: id,
        replaceBackground: TOPICS[topic]
      })

      preview.style.opacity = '.3'

      preview.src = url
      preview.onload = () => {
        preview.style.opacity = '1'
      }
    })
  })

  downloadButton.addEventListener('click', (e) => {
    const url = getCldImageUrl({ src: id, format: 'avif' })

    const a = document.createElement('a')
    a.href = url
    a.download = 'image.avif'
    a.click()
  })
</script>
